var o=document.querySelector("rl-display");function c(e,t,a,r){let n=Math.abs(e-a),s=Math.abs(t-r);return Math.max(n,s)}function x(e,t,a,r){let n=e-a,s=t-r;return Math.sqrt(n**2+s**2)}function b(e){return new Promise(t=>setTimeout(t,e))}Array.prototype.random=function(){return this[Math.floor(Math.random()*this.length)]};String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.substring(1)};function z(e){let t={ch:e};switch(e){case"/":t.fg="saddlebrown";break;case".":t.fg="#aaa";break;case"#":t.fg="#666";break}return t}var d={hero:[0,0],spawn1:[],spawn2:[],spawn3:[]},v=[];function k(e){let t=`spawn${e}`;return d[t].random()}function B(e){return d[e]}function u(e,t){return v.filter(a=>c(e,t,...a)==1)}function $(e,t,a){if(e==" ")return;switch(e){case"@":d.hero=[t,a],e=".";break;case"1":case"2":case"3":let n=`spawn${e}`;d[n].push([t,a]),e=".";break}(e=="."||e=="/")&&v.push([t,a]);let r=z(e);o.draw(t,a,r)}function M(){let t=document.querySelector("[type=map]").textContent.trim().split(`
`),a=0;t.forEach((r,n)=>{a=Math.max(a,r.length),r.split("").forEach((s,l)=>$(s,l+1,n+1))}),o.rows=t.length+2,o.cols=a+2}var q=[{name:"fire",color:"red"},{name:"frost",color:"dodgerblue"},{name:"poison",color:"lime"}],D=["sharp","rusty","dangerous-looking"],G=["of vengeance","of destiny","of chaos"],L=["sword","dagger","saber"],U=["wooden","oaken","hickory"],j=["short bow","bow","longbow"],m=[];function P(){return m}function S(e,t){for(let a of m)if(a.x==e&&a.y==t)return a}function f(e,t,a){e.x=t,e.y=a,m.push(e),o.draw(t,a,e.visual,{zIndex:1})}function T(e){console.log("removing",e);let t=m.indexOf(e);m.splice(t,1),o.clear(e.x,e.y,1)}function y(e){switch(e){case"sword":{let t=[],a=.5;Math.random()<a&&t.push(D.random().capitalize()),t.push(L.random()),Math.random()>a&&t.push(G.random());let r=["#999","#aaa","#ccc"].random();return{type:e,name:t.join(" "),visual:{ch:["(",")"].random(),fg:r}}}case"bow":{let t=[U.random(),j.random()].join(" ");return{type:e,name:t,visual:{ch:["{","}"].random(),fg:"saddlebrown"}}}case"wand":{let t=q.random();return{type:e,name:`Wand of ${t.name}`,visual:{ch:"I",fg:t.color}}}}}var H=[{name:"orc",visual:{ch:"o",fg:"green"},weaponType:"sword"},{name:"orc shaman",visual:{ch:"o",fg:"lime"},weaponType:"wand"},{name:"ogre",visual:{ch:"O",fg:"green"},weaponType:"sword"},{name:"ogre shaman",visual:{ch:"O",fg:"lime"},weaponType:"wand"},{name:"goblin",visual:{ch:"g",fg:"green"},weaponType:"sword"},{name:"goblin archer",visual:{ch:"g",fg:"blue"},weaponType:"bow"}];function g(){let e=H.random();return{id:Math.random(),x:0,y:0,goal:{type:"idle"},name:e.name,visual:e.visual,weapon:y(e.weaponType)}}async function I(e){let t=["fade-out","explode"];await o.fx(e.id,t.random()).finished,o.delete(e.id);let a=u(e.x,e.y);if(a.length>0&&Math.random()>.5){let{weapon:n}=e,s={x:0,y:0,visual:n.visual,name:n.name,weapon:n};f(s,...a.random())}let r=Math.random();if(r>.667)f({x:0,y:0,visual:{ch:"$",fg:"gold"},name:"gold"},e.x,e.y);else if(r>.333){let n={x:0,y:0,visual:{ch:"%",fg:e.visual.fg},name:`${e.name} corpse`};f(n,e.x,e.y)}}var p=[],i={name:"Hector the Barbarian",id:"hero",x:0,y:0,visual:{ch:"@",fg:"goldenrod"},goal:{type:"idle"},weapon:y("sword")};function W(e,t,a){e.x=t,e.y=a,p.push(e),o.draw(e.x,e.y,e.visual,{id:e.id,zIndex:2})}function F(e,t,a){return e.x=t,e.y=a,e==i&&o.panTo(t,a,100),o.move(e.id,t,a,100)}function N(e){let t=u(e.x,e.y);return F(e,...t.random())}async function X(e,t){if(t==i)return o.fx(i.id,"pulse");{await I(t);let a=p.indexOf(t);p.splice(a),e.goal={type:"idle"}}}function _(e){let t=S(e.x,e.y);t&&(T(t),t.weapon&&(e.weapon=t.weapon),e.goal={type:"idle"})}function A(e,t,a){return c(e.x,e.y,t.x,t.y)<=a}function O(e,t){let a=u(e.x,e.y),r=[],n=1/0;return a.forEach(s=>{let l=x(...s,t.x,t.y);l<n&&(n=l,r=[]),l==n&&r.push(s)}),F(e,...r.random())}function V(e){switch(e.goal.type){case"idle":return N(e);case"attack":return A(e,e.goal.target,1)?X(e,e.goal.target):O(e,e.goal.target);case"pickup":return A(e,e.goal.target,0)?_(e):O(e,e.goal.target)}}function J(){let e=Math.floor(Math.random()*3)+1,t;switch(e){case 1:t=g();break;case 2:t=g();break;case 3:t=g();break}i.goal={type:"attack",target:t},t.goal={type:"attack",target:i};let[a,r]=k(e);W(t,a,r)}async function C(){let e=p.shift();if(await V(e),p.push(e),e==i&&e.goal.type=="idle"){let t=P();t.length>0?e.goal={type:"pickup",target:t[0]}:J()}}function R(){let[e,t]=B("hero");W(i,e,t)}function Y(){M(),R()}async function Z(){for(;;)await C(),await b(300)}Y();Z();
