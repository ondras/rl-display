var i=document.querySelector("rl-display");function f(e,t,n,o){let a=Math.abs(e-n),r=Math.abs(t-o);return Math.max(a,r)}function p(e,t,n,o){let a=e-n,r=t-o;return Math.sqrt(a**2+r**2)}function E(e){return new Promise(t=>setTimeout(t,e))}Array.prototype.random=function(){return this[Math.floor(Math.random()*this.length)]};String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.substring(1)};function Q(e){let t={ch:e};switch(e){case"/":t.fg="saddlebrown";break;case".":t.fg="#aaa";break;case"#":t.fg="#666";break}return t}var g={center:[0,0],spawn1:[],spawn2:[],spawn3:[]},I=[];function S(e){let t=`spawn${e}`;return g[t].random()}function x(e){return g[e]}function c(e,t){return I.filter(n=>f(e,t,...n)==1)}function Y(e,t,n){if(e==" ")return;switch(e){case"@":g.center=[t,n],e=".";break;case"1":case"2":case"3":let a=`spawn${e}`;g[a].push([t,n]),e=".";break}(e=="."||e=="/")&&I.push([t,n]);let o=Q(e);i.draw(t,n,o)}function C(){let t=document.querySelector("[type=map]").textContent.trim().split(`
`),n=0;t.forEach((o,a)=>{n=Math.max(n,o.length),o.split("").forEach((r,u)=>Y(r,u+1,a+1))}),i.rows=t.length+2,i.cols=n+2}var Z=[{name:"fire",color:"red"},{name:"frost",color:"dodgerblue"},{name:"poison",color:"lime"}],ee=["Sharp","Rusty","Dangerous-looking"],te=["of Vengeance","of Destiny","of Chaos"],ne=["sword","dagger","saber"],ae=["Wooden","Oaken","Hickory"],oe=["short bow","bow","longbow"],d=[];function W(){return d}function L(e,t){for(let n of d)if(n.x==e&&n.y==t)return n}function h(e,t,n){e.x=t,e.y=n,d.push(e),i.draw(t,n,e.visual,{zIndex:1})}function F(e){console.log("removing",e);let t=d.indexOf(e);d.splice(t,1),i.clear(e.x,e.y,1)}function v(e){switch(e){case"sword":{let t=[],n=.5;Math.random()<n&&t.push(ee.random()),t.push(ne.random()),Math.random()>n&&t.push(te.random());let o=["#999","#aaa","#ccc"].random();return{type:e,name:t.join(" "),visual:{ch:["(",")"].random(),fg:o}}}case"bow":{let t=[ae.random(),oe.random()].join(" ");return{type:e,name:t,visual:{ch:["{","}"].random(),fg:"saddlebrown"}}}case"wand":{let t=Z.random();return{type:e,name:`Wand of ${t.name}`,visual:{ch:"I",fg:t.color}}}}}var s={name:"Hector the Barbarian",named:!0,id:"hero",x:0,y:0,visual:{ch:"@",fg:"goldenrod"},goal:{type:"idle"},weapon:v("sword")},re=[{name:"orc",visual:{ch:"o",fg:"green"},weaponType:"sword"},{name:"orc shaman",visual:{ch:"o",fg:"lime"},weaponType:"wand"},{name:"ogre",visual:{ch:"O",fg:"green"},weaponType:"sword"},{name:"ogre shaman",visual:{ch:"O",fg:"lime"},weaponType:"wand"},{name:"goblin",visual:{ch:"g",fg:"green"},weaponType:"sword"},{name:"goblin archer",visual:{ch:"g",fg:"blue"},weaponType:"bow"}];function R(){let e=Math.floor(Math.random()*3)+1,t;switch(e){case 1:t=k();break;case 2:t=k();break;case 3:t=k();break}return s.goal={type:"attack",target:t},t.goal={type:"attack",target:s},B(t,...S(e)),t}function B(e,t,n){e.x=t,e.y=n,i.draw(e.x,e.y,e.visual,{id:e.id,zIndex:2})}function k(){let e=re.random();return{id:Math.random(),x:0,y:0,named:!1,goal:{type:"idle"},name:e.name,visual:e.visual,weapon:v(e.weaponType)}}async function $(e){let t=["fade-out","explode"];await i.fx(e.id,t.random()).finished,i.delete(e.id);let n=c(e.x,e.y);if(n.length>0&&Math.random()>.5){let{weapon:a}=e,r={x:0,y:0,visual:a.visual,name:a.name,weapon:a};h(r,...n.random())}let o=Math.random();if(o>.667)h({x:0,y:0,visual:{ch:"$",fg:"gold"},name:"gold"},e.x,e.y);else if(o>.333){let a={x:0,y:0,visual:{ch:"%",fg:e.visual.fg},name:`${e.name} corpse`};h(a,e.x,e.y)}}var se=10,D=document.querySelector("#log"),M=[],l;function q(e,...t){return e.replace(/%(\w+)/g,(n,o)=>{let a=t.shift();if(!a)return"!!!";let r=n;switch(o.toLowerCase()){case"a":r=a.name,a.named||(r=`${r.charAt(0).match(/[aeiouy]/i)?"an ":"a "} ${r}`);break;case"the":r=a.name,a.named||(r=`the ${r}`);break;case"s":r=a.name;break}return o.charAt(0)==o.charAt(0).toUpperCase()&&(r=r.capitalize()),r})}function z(e,t){return q("%A attacks %a with his %s.",e,t,e.weapon)}function H(e,t){return q("%A picks up %the.",e,t)}function T(){if(!(l&&!l.childElementCount)){for(l=document.createElement("div"),M.push(l);M.length>se;)M.shift().remove();D.append(l)}}function P(e){let t=document.createElement("span");t.textContent=e,l.append(t," ")}function G(){setInterval(()=>D.scrollTop+=3,20),T()}var m=[];function N(e,t,n){return e.x=t,e.y=n,e==s&&i.panTo(t,n,100),i.move(e.id,t,n,100)}function le(e){let t=c(e.x,e.y);return N(e,...t.random())}async function me(e,t){let n=z(e,t);if(P(n),t==s)return i.fx(t.id,"pulse");{await $(t);let o=m.indexOf(t);m.splice(o),e.goal={type:"idle"}}}function ue(e){let t=L(e.x,e.y);if(!t)return;let n=H(e,t);P(n),F(t),t.weapon&&(e.weapon=t.weapon),e.goal={type:"idle"}}function j(e,t,n){return f(e.x,e.y,t.x,t.y)<=n}function K(e,t){let n=c(e.x,e.y),o=[],a=1/0,r=x("center"),u=p(e.x,e.y,t.x,t.y),_=p(e.x,e.y,...r),J=p(t.x,t.y,...r);return u>_&&u>J&&(t={x:r[0],y:r[1]}),n.forEach(A=>{let y=p(...A,t.x,t.y);y<a&&(a=y,o=[]),y==a&&o.push(A)}),N(e,...o.random())}function pe(e){switch(e.goal.type){case"idle":return le(e);case"attack":return j(e,e.goal.target,1)?me(e,e.goal.target):K(e,e.goal.target);case"pickup":return j(e,e.goal.target,0)?ue(e):K(e,e.goal.target)}}async function V(){T();let e=m.shift();if(await pe(e),m.push(e),e==s&&e.goal.type=="idle"){let t=W();if(t.length>0)e.goal={type:"pickup",target:t[0]};else{let n=R();m.push(n)}}}function X(){B(s,...x("center")),m.push(s)}function de(){G(),C(),X()}async function fe(){for(;;)await V(),await E(300)}de();fe();
