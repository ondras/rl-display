var r=document.querySelector("rl-display");function f(e,t,n,o){let a=Math.abs(e-n),i=Math.abs(t-o);return Math.max(a,i)}function u(e,t,n,o){let a=e-n,i=t-o;return Math.sqrt(a**2+i**2)}function I(e){return new Promise(t=>setTimeout(t,e))}Array.prototype.random=function(){return this[Math.floor(Math.random()*this.length)]};String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.substring(1)};function Q(e){let t={ch:e};switch(e){case"/":t.fg="saddlebrown";break;case".":t.fg="#aaa";break;case"#":t.fg="#666";break}return t}var g={center:[0,0],spawn1:[],spawn2:[],spawn3:[]},S=[];function A(e){let t=`spawn${e}`;return g[t].random()}function x(e){return g[e]}function p(e,t){return S.filter(n=>f(e,t,...n)==1)}function Y(e,t,n){if(e==" ")return;switch(e){case"@":g.center=[t,n],e=".";break;case"1":case"2":case"3":let a=`spawn${e}`;g[a].push([t,n]),e=".";break}(e=="."||e=="/")&&S.push([t,n]);let o=Q(e);r.draw(t,n,o)}function C(){let t=document.querySelector("[type=map]").textContent.trim().split(`
`),n=0;t.forEach((o,a)=>{n=Math.max(n,o.length),o.split("").forEach((i,d)=>Y(i,d+1,a+1))}),r.rows=t.length+2,r.cols=n+2}var Z=[{name:"fire",color:"red"},{name:"frost",color:"dodgerblue"},{name:"poison",color:"lime"}],ee=["Sharp","Rusty","Dangerous-looking"],te=["of Vengeance","of Destiny","of Chaos"],ne=["sword","dagger","saber"],oe=["Wooden","Oaken","Hickory"],ae=["short bow","bow","longbow"],c=[];function W(){return c}function $(e,t){for(let n of c)if(n.x==e&&n.y==t)return n}function y(e,t,n){e.x=t,e.y=n,c.push(e),r.draw(t,n,e.visual,{zIndex:1})}function L(e){console.log("removing",e);let t=c.indexOf(e);c.splice(t,1),r.clear(e.x,e.y,1)}function v(e){switch(e){case"sword":{let t=[],n=.5;Math.random()<n&&t.push(ee.random()),t.push(ne.random()),Math.random()>n&&t.push(te.random());let o=["#999","#aaa","#ccc"].random();return{type:e,name:t.join(" "),visual:{ch:["(",")"].random(),fg:o}}}case"bow":{let t=[oe.random(),ae.random()].join(" ");return{type:e,name:t,visual:{ch:["{","}"].random(),fg:"saddlebrown"}}}case"wand":{let t=Z.random();return{type:e,name:`Wand of ${t.name}`,visual:{ch:"I",fg:t.color}}}}}var s={name:"Hector the Barbarian",named:!0,id:"hero",x:0,y:0,visual:{ch:"@",fg:"goldenrod"},goal:{type:"idle"},weapon:v("sword")},re=[{name:"orc",visual:{ch:"o",fg:"green"},weaponType:"sword"},{name:"orc shaman",visual:{ch:"o",fg:"lime"},weaponType:"wand"},{name:"ogre",visual:{ch:"O",fg:"green"},weaponType:"sword"},{name:"ogre shaman",visual:{ch:"O",fg:"lime"},weaponType:"wand"},{name:"goblin",visual:{ch:"g",fg:"green"},weaponType:"sword"},{name:"goblin archer",visual:{ch:"g",fg:"blue"},weaponType:"bow"}];function O(){let e=Math.floor(Math.random()*3)+1,t;switch(e){case 1:t=k();break;case 2:t=k();break;case 3:t=k();break}return s.goal={type:"attack",target:t},t.goal={type:"attack",target:s},B(t,...A(e)),t}function B(e,t,n){e.x=t,e.y=n,r.draw(e.x,e.y,e.visual,{id:e.id,zIndex:2})}function k(){let e=re.random();return{id:Math.random(),x:0,y:0,named:!1,goal:{type:"idle"},name:e.name,visual:e.visual,weapon:v(e.weaponType)}}async function R(e){let t=["fade-out","explode"];await r.fx(e.id,t.random()).finished,r.delete(e.id);let n=p(e.x,e.y);if(n.length>0&&Math.random()>.5){let{weapon:a}=e,i={x:0,y:0,visual:a.visual,name:a.name,weapon:a};y(i,...n.random())}let o=Math.random();if(o>.667)y({x:0,y:0,visual:{ch:"$",fg:"gold"},name:"gold"},e.x,e.y);else if(o>.333){let a={x:0,y:0,visual:{ch:"%",fg:e.visual.fg},name:`${e.name} corpse`};y(a,e.x,e.y)}}var se=10,D=document.querySelector("#log"),M=[],l;function z(e){let t="";return e.named||(t=e.name.charAt(0).toLowerCase().match(/[aeiouy]/)?"an ":"a "),`${t}${e.name}`}function q(e,t){return`${z(e)} attacks ${z(t)} with his ${e.weapon.name}.`.capitalize()}function H(e,t){return`${e.name} picks up the ${t.name}.`.capitalize()}function T(){if(!(l&&!l.childElementCount)){for(l=document.createElement("div"),M.push(l);M.length>se;)M.shift().remove();D.append(l)}}function P(e){let t=document.createElement("span");t.textContent=e,l.append(t," ")}function G(){setInterval(()=>D.scrollTop+=3,20),T()}var m=[];function N(e,t,n){return e.x=t,e.y=n,e==s&&r.panTo(t,n,100),r.move(e.id,t,n,100)}function le(e){let t=p(e.x,e.y);return N(e,...t.random())}async function me(e,t){let n=q(e,t);if(P(n),t==s)return r.fx(t.id,"pulse");{await R(t);let o=m.indexOf(t);m.splice(o),e.goal={type:"idle"}}}function ue(e){let t=$(e.x,e.y);if(!t)return;let n=H(e,t);P(n),L(t),t.weapon&&(e.weapon=t.weapon),e.goal={type:"idle"}}function j(e,t,n){return f(e.x,e.y,t.x,t.y)<=n}function K(e,t){let n=p(e.x,e.y),o=[],a=1/0,i=x("center"),d=u(e.x,e.y,t.x,t.y),_=u(e.x,e.y,...i),J=u(t.x,t.y,...i);return d>_&&d>J&&(t={x:i[0],y:i[1]}),n.forEach(E=>{let h=u(...E,t.x,t.y);h<a&&(a=h,o=[]),h==a&&o.push(E)}),N(e,...o.random())}function pe(e){switch(e.goal.type){case"idle":return le(e);case"attack":return j(e,e.goal.target,1)?me(e,e.goal.target):K(e,e.goal.target);case"pickup":return j(e,e.goal.target,0)?ue(e):K(e,e.goal.target)}}async function V(){T();let e=m.shift();if(await pe(e),m.push(e),e==s&&e.goal.type=="idle"){let t=W();if(t.length>0)e.goal={type:"pickup",target:t[0]};else{let n=O();m.push(n)}}}function X(){B(s,...x("center")),m.push(s)}function de(){G(),C(),X()}async function fe(){for(;;)await V(),await I(300)}de();fe();
