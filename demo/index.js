var i=document.querySelector("rl-display");function h(e,t,n,o){let a=Math.abs(e-n),r=Math.abs(t-o);return Math.max(a,r)}function p(e,t,n,o){let a=e-n,r=t-o;return Math.sqrt(a**2+r**2)}function I(e){return new Promise(t=>setTimeout(t,e))}Array.prototype.random=function(){return this[Math.floor(Math.random()*this.length)]};String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.substring(1)};function Z(e){let t={ch:e};switch(e){case"/":t.fg="saddlebrown";break;case".":t.fg="#aaa";break;case"#":t.fg="#666";break}return t}var y={center:[0,0],spawn1:[],spawn2:[],spawn3:[]},S=[];function C(e){let t=`spawn${e}`;return y[t].random()}function k(e){return y[e]}function c(e,t){return S.filter(n=>h(e,t,...n)==1)}function ee(e,t,n){if(e==" ")return;switch(e){case"@":y.center=[t,n],e=".";break;case"1":case"2":case"3":let a=`spawn${e}`;y[a].push([t,n]),e=".";break}(e=="."||e=="/")&&S.push([t,n]);let o=Z(e);i.draw(t,n,o)}function W(){let t=document.querySelector("[type=map]").textContent.trim().split(`
`),n=0;t.forEach((o,a)=>{n=Math.max(n,o.length),o.split("").forEach((r,u)=>ee(r,u+1,a+1))}),i.rows=t.length+2,i.cols=n+2}var te=[{name:"fire",color:"red"},{name:"frost",color:"dodgerblue"},{name:"poison",color:"lime"}],ne=["Sharp","Rusty","Dangerous-looking"],ae=["of Vengeance","of Destiny","of Chaos"],oe=["sword","dagger","saber"],re=["Wooden","Oaken","Hickory"],ie=["short bow","bow","longbow"],d=[];function L(){return d}function D(e,t){for(let n of d)if(n.x==e&&n.y==t)return n}function w(e,t,n){e.x=t,e.y=n,d.push(e),i.draw(t,n,e.visual,{zIndex:1})}function F(e){console.log("removing",e);let t=d.indexOf(e);d.splice(t,1),i.deleteAt(e.x,e.y,1)}function T(e){switch(e){case"sword":{let t=[],n=.5;Math.random()<n&&t.push(ne.random()),t.push(oe.random()),Math.random()>n&&t.push(ae.random());let o=["#999","#aaa","#ccc"].random();return{type:e,name:t.join(" "),visual:{ch:["(",")"].random(),fg:o}}}case"bow":{let t=[re.random(),ie.random()].join(" ");return{type:e,name:t,visual:{ch:["{","}"].random(),fg:"saddlebrown"}}}case"wand":{let t=te.random();return{type:e,name:`Wand of ${t.name}`,visual:{ch:"I",fg:t.color}}}}}var s={name:"Hector the Barbarian",named:!0,id:"hero",x:0,y:0,visual:{ch:"@",fg:"goldenrod"},goal:{type:"idle"},weapon:T("sword")},se=[{name:"orc",visual:{ch:"o",fg:"green"},weaponType:"sword"},{name:"orc shaman",visual:{ch:"o",fg:"lime"},weaponType:"wand"},{name:"ogre",visual:{ch:"O",fg:"green"},weaponType:"sword"},{name:"ogre shaman",visual:{ch:"O",fg:"lime"},weaponType:"wand"},{name:"goblin",visual:{ch:"g",fg:"green"},weaponType:"sword"},{name:"goblin archer",visual:{ch:"g",fg:"blue"},weaponType:"bow"}];function $(){let e=Math.floor(Math.random()*3)+1,t;switch(e){case 1:t=B();break;case 2:t=B();break;case 3:t=B();break}return s.goal={type:"attack",target:t},t.goal={type:"attack",target:s},M(t,...C(e)),t}function M(e,t,n){e.x=t,e.y=n,i.draw(e.x,e.y,e.visual,{id:e.id,zIndex:2})}function B(){let e=se.random();return{id:Math.random(),x:0,y:0,named:!1,goal:{type:"idle"},name:e.name,visual:e.visual,weapon:T(e.weaponType)}}async function R(e){let t=["fade-out","explode"];await i.fx(e.id,t.random()).finished,i.delete(e.id);let n=c(e.x,e.y);if(n.length>0&&Math.random()>.5){let{weapon:a}=e,r={x:0,y:0,visual:a.visual,name:a.name,weapon:a};w(r,...n.random())}let o=Math.random();if(o>.667)w({x:0,y:0,visual:{ch:"$",fg:"gold"},named:!0,name:"some gold"},e.x,e.y);else if(o>.333){let a={x:0,y:0,visual:{ch:"%",fg:e.visual.fg},edible:!0,name:`${e.name} corpse`};w(a,e.x,e.y)}}var me=10,q=document.querySelector("#log"),A=[],l;function f(e,...t){return e.replace(/%(\w+)/g,(n,o)=>{let a=t.shift();if(!a)return"!!!";let r=n;switch(o.toLowerCase()){case"a":r=a.name,a.named||(r=`${r.charAt(0).match(/[aeiouy]/i)?"an ":"a "} ${r}`);break;case"the":r=a.name,a.named||(r=`the ${r}`);break;case"s":r=a.name;break}return o.charAt(0)==o.charAt(0).toUpperCase()&&(r=r.capitalize()),r})}function z(e,t){return f("%A attacks %a with his %s.",e,t,e.weapon)}function H(e,t){if(t.edible){let n=["Tastes good.","Yummy!","Tough but nutritious."].random();return f(`%A eats %the. ${n}`,e,t)}else return f("%A picks up %the.",e,t)}function G(e){return f(["%The evades the attack.","The attack misses.","%The's armor protects him."].random(),e)}function U(e){return f(["%The is killed!","%The is hit and slain.","%The is killed on the spot."].random(),e)}function P(){if(!(l&&!l.childElementCount)){for(l=document.createElement("div"),A.push(l);A.length>me;)A.shift().remove();q.append(l)}}function g(e){let t=document.createElement("span");t.textContent=e,l.append(t," ")}function j(){setInterval(()=>q.scrollTop+=3,20),P()}var m=[];function X(e,t,n){return e.x=t,e.y=n,e==s&&i.panTo(t,n,100),i.move(e.id,t,n,100)}function ue(e){let t=c(e.x,e.y);return X(e,...t.random())}async function pe(e,t){let n=z(e,t);if(g(n),t==s){let o=G(t);return g(o),i.fx(t.id,"pulse")}else{await R(t);let o=U(t);g(o);let a=m.indexOf(t);m.splice(a),e.goal={type:"idle"}}}function ce(e){let t=D(e.x,e.y);if(!t)return;let n=H(e,t);g(n),F(t),t.weapon&&(e.weapon=t.weapon),e.goal={type:"idle"}}function N(e,t,n){return h(e.x,e.y,t.x,t.y)<=n}function V(e,t){let n=c(e.x,e.y),o=[],a=1/0,r=k("center"),u=p(e.x,e.y,t.x,t.y),J=p(e.x,e.y,...r),Q=p(t.x,t.y,...r);return u>J&&u>Q&&(t={x:r[0],y:r[1]}),n.forEach(E=>{let x=p(...E,t.x,t.y);x<a&&(a=x,o=[]),x==a&&o.push(E)}),X(e,...o.random())}function de(e){switch(e.goal.type){case"idle":return ue(e);case"attack":return N(e,e.goal.target,1)?pe(e,e.goal.target):V(e,e.goal.target);case"pickup":return N(e,e.goal.target,0)?ce(e):V(e,e.goal.target)}}async function _(){P();let e=m.shift();if(await de(e),m.push(e),e==s&&e.goal.type=="idle"){let t=L();if(t.length>0)e.goal={type:"pickup",target:t[0]};else{let n=$();m.push(n)}}}function Y(){M(s,...k("center")),m.push(s)}function ge(){j(),W(),Y()}async function he(){for(;;)await _(),await I(300)}ge();he();
