var n=document.querySelector("rl-display");function m(e,t,r,a){let o=Math.abs(e-r),i=Math.abs(t-a);return Math.max(o,i)}function w(e,t,r,a){let o=e-r,i=t-a;return Math.sqrt(o**2+i**2)}function h(e){return new Promise(t=>setTimeout(t,e))}Array.prototype.random=function(){return this[Math.floor(Math.random()*this.length)]};String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.substring(1)};function z(e){let t={ch:e};switch(e){case"/":t.fg="saddlebrown";break;case".":t.fg="#aaa";break;case"#":t.fg="#666";break}return t}var c={hero:[0,0],spawn1:[],spawn2:[],spawn3:[]},b=[];function x(e){let t=`spawn${e}`;return c[t].random()}function v(e){return c[e]}function g(e,t){return b.filter(r=>m(e,t,...r)==1)}function q(e,t,r){if(e==" ")return;switch(e){case"@":c.hero=[t,r],e=".";break;case"1":case"2":case"3":let o=`spawn${e}`;c[o].push([t,r]),e=".";break}(e=="."||e=="/")&&b.push([t,r]);let a=z(e);n.draw(t,r,a)}function k(){let t=document.querySelector("[type=map]").textContent.trim().split(`
`),r=0;t.forEach((a,o)=>{r=Math.max(r,a.length),a.split("").forEach((i,l)=>q(i,l+1,o+1))}),n.rows=t.length+2,n.cols=r+2}var D=[{name:"fire",color:"red"},{name:"frost",color:"dodgerblue"},{name:"poison",color:"lime"}],G=["sharp","rusty","dangerous-looking"],L=["of vengeance","of destiny","of chaos"],U=["sword","dagger","saber"],$=["wooden","oaken","hickory"],j=["short bow","bow","longbow"],u=[];function M(){return u}function S(e,t){for(let r of u)if(r.x==e&&r.y==t)return r}function P(e,t,r){e.x=t,e.y=r,u.push(e),n.draw(t,r,e.visual,{zIndex:1})}function T(e){console.log("removing",e);let t=u.indexOf(e);u.splice(t,1),n.clear(e.x,e.y,1)}function f(e){switch(e){case"sword":{let t=[],r=.5;Math.random()<r&&t.push(G.random().capitalize()),t.push(U.random()),Math.random()>r&&t.push(L.random());let a=["#999","#aaa","#ccc"].random();return{type:e,name:t.join(" "),visual:{ch:["(",")"].random(),fg:a}}}case"bow":{let t=[$.random(),j.random()].join(" ");return{type:e,name:t,visual:{ch:["{","}"].random(),fg:"saddlebrown"}}}case"wand":{let t=D.random();return{type:e,name:`Wand of ${t.name}`,visual:{ch:"I",fg:t.color}}}}}var H=[{name:"orc",visual:{ch:"o",fg:"green"},weaponType:"sword"},{name:"orc shaman",visual:{ch:"o",fg:"lime"},weaponType:"wand"},{name:"ogre",visual:{ch:"O",fg:"green"},weaponType:"sword"},{name:"ogre shaman",visual:{ch:"O",fg:"lime"},weaponType:"wand"},{name:"goblin",visual:{ch:"g",fg:"green"},weaponType:"sword"},{name:"goblin archer",visual:{ch:"g",fg:"blue"},weaponType:"bow"}];function d(){let e=H.random();return{id:Math.random(),x:0,y:0,goal:{type:"idle"},name:e.name,visual:e.visual,weapon:f(e.weaponType)}}function I(e){n.delete(e.id);let{weapon:t}=e,r={x:0,y:0,visual:t.visual,name:t.name,weapon:t};P(r,e.x,e.y)}var p=[],s={name:"Hector the ...",id:"hero",x:0,y:0,visual:{ch:"@",fg:"goldenrod"},goal:{type:"idle"},weapon:f("sword")};function W(e,t,r){e.x=t,e.y=r,p.push(e),n.draw(e.x,e.y,e.visual,{id:e.id,zIndex:2})}function F(e,t,r){return e.x=t,e.y=r,e==s&&n.panTo(t,r,100),n.move(e.id,t,r,100)}function N(e){let t=g(e.x,e.y);return F(e,...t.random())}function X(e,t){if(t==s)return n.fx(s.id,"pulse");{I(t);let r=p.indexOf(t);p.splice(r),e.goal={type:"idle"}}}function _(e){let t=S(e.x,e.y);t&&(T(t),t.weapon&&(e.weapon=t.weapon),e.goal={type:"idle"})}function A(e,t,r){return m(e.x,e.y,t.x,t.y)<=r}function O(e,t){let r=g(e.x,e.y),a=[],o=1/0;return r.forEach(i=>{let l=w(...i,t.x,t.y);l<o&&(o=l,a=[]),l==o&&a.push(i)}),F(e,...a.random())}function V(e){switch(e.goal.type){case"idle":return N(e);case"attack":return A(e,e.goal.target,1)?X(e,e.goal.target):O(e,e.goal.target);case"pickup":return A(e,e.goal.target,0)?_(e):O(e,e.goal.target)}}function J(){let e=Math.floor(Math.random()*3)+1,t;switch(e){case 1:t=d();break;case 2:t=d();break;case 3:t=d();break}s.goal={type:"attack",target:t},t.goal={type:"attack",target:s};let[r,a]=x(e);W(t,r,a)}async function C(){let e=p.shift();if(await V(e),p.push(e),e==s&&e.goal.type=="idle"){let t=M();t.length>0?e.goal={type:"pickup",target:t[0]}:J()}}function R(){let[e,t]=v("hero");W(s,e,t)}function Y(){k(),R()}async function Z(){for(;;)await C(),await h(300)}Y();Z();
