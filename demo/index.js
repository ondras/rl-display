var r=document.querySelector("rl-display");function f(e,t,n,o){let a=Math.abs(e-n),i=Math.abs(t-o);return Math.max(a,i)}function M(e,t,n,o){let a=e-n,i=t-o;return Math.sqrt(a**2+i**2)}function E(e){return new Promise(t=>setTimeout(t,e))}Array.prototype.random=function(){return this[Math.floor(Math.random()*this.length)]};String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.substring(1)};function V(e){let t={ch:e};switch(e){case"/":t.fg="saddlebrown";break;case".":t.fg="#aaa";break;case"#":t.fg="#666";break}return t}var d={hero:[0,0],spawn1:[],spawn2:[],spawn3:[]},P=[];function I(e){let t=`spawn${e}`;return d[t].random()}function S(e){return d[e]}function p(e,t){return P.filter(n=>f(e,t,...n)==1)}function X(e,t,n){if(e==" ")return;switch(e){case"@":d.hero=[t,n],e=".";break;case"1":case"2":case"3":let a=`spawn${e}`;d[a].push([t,n]),e=".";break}(e=="."||e=="/")&&P.push([t,n]);let o=V(e);r.draw(t,n,o)}function T(){let t=document.querySelector("[type=map]").textContent.trim().split(`
`),n=0;t.forEach((o,a)=>{n=Math.max(n,o.length),o.split("").forEach((i,u)=>X(i,u+1,a+1))}),r.rows=t.length+2,r.cols=n+2}var _=[{name:"fire",color:"red"},{name:"frost",color:"dodgerblue"},{name:"poison",color:"lime"}],J=["Sharp","Rusty","Dangerous-looking"],Q=["of Vengeance","of Destiny","of Chaos"],Y=["sword","dagger","saber"],Z=["Wooden","Oaken","Hickory"],ee=["short bow","bow","longbow"],c=[];function A(){return c}function W(e,t){for(let n of c)if(n.x==e&&n.y==t)return n}function g(e,t,n){e.x=t,e.y=n,c.push(e),r.draw(t,n,e.visual,{zIndex:1})}function $(e){console.log("removing",e);let t=c.indexOf(e);c.splice(t,1),r.clear(e.x,e.y,1)}function y(e){switch(e){case"sword":{let t=[],n=.5;Math.random()<n&&t.push(J.random()),t.push(Y.random()),Math.random()>n&&t.push(Q.random());let o=["#999","#aaa","#ccc"].random();return{type:e,name:t.join(" "),visual:{ch:["(",")"].random(),fg:o}}}case"bow":{let t=[Z.random(),ee.random()].join(" ");return{type:e,name:t,visual:{ch:["{","}"].random(),fg:"saddlebrown"}}}case"wand":{let t=_.random();return{type:e,name:`Wand of ${t.name}`,visual:{ch:"I",fg:t.color}}}}}var s={name:"Hector the Barbarian",named:!0,id:"hero",x:0,y:0,visual:{ch:"@",fg:"goldenrod"},goal:{type:"idle"},weapon:y("sword")},te=[{name:"orc",visual:{ch:"o",fg:"green"},weaponType:"sword"},{name:"orc shaman",visual:{ch:"o",fg:"lime"},weaponType:"wand"},{name:"ogre",visual:{ch:"O",fg:"green"},weaponType:"sword"},{name:"ogre shaman",visual:{ch:"O",fg:"lime"},weaponType:"wand"},{name:"goblin",visual:{ch:"g",fg:"green"},weaponType:"sword"},{name:"goblin archer",visual:{ch:"g",fg:"blue"},weaponType:"bow"}];function F(){let e=Math.floor(Math.random()*3)+1,t;switch(e){case 1:t=x();break;case 2:t=x();break;case 3:t=x();break}return s.goal={type:"attack",target:t},t.goal={type:"attack",target:s},b(t,...I(e)),t}function b(e,t,n){e.x=t,e.y=n,r.draw(e.x,e.y,e.visual,{id:e.id,zIndex:2})}function x(){let e=te.random();return{id:Math.random(),x:0,y:0,named:!1,goal:{type:"idle"},name:e.name,visual:e.visual,weapon:y(e.weaponType)}}async function O(e){let t=["fade-out","explode"];await r.fx(e.id,t.random()).finished,r.delete(e.id);let n=p(e.x,e.y);if(n.length>0&&Math.random()>.5){let{weapon:a}=e,i={x:0,y:0,visual:a.visual,name:a.name,weapon:a};g(i,...n.random())}let o=Math.random();if(o>.667)g({x:0,y:0,visual:{ch:"$",fg:"gold"},name:"gold"},e.x,e.y);else if(o>.333){let a={x:0,y:0,visual:{ch:"%",fg:e.visual.fg},name:`${e.name} corpse`};g(a,e.x,e.y)}}var oe=10,R=document.querySelector("#log"),v=[],l;function L(e){let t="";return e.named||(t=e.name.charAt(0).toLowerCase().match(/[aeiouy]/)?"an ":"a "),`${t}${e.name}`}function z(e,t){return`${L(e)} attacks ${L(t)} with his ${e.weapon.name}.`.capitalize()}function D(e,t){return`${e.name} picks up the ${t.name}.`.capitalize()}function k(){if(!(l&&!l.childElementCount)){for(l=document.createElement("div"),v.push(l);v.length>oe;)v.shift().remove();R.append(l)}}function B(e){let t=document.createElement("span");t.textContent=e,l.append(t," ")}function q(){setInterval(()=>R.scrollTop+=3,20),k()}var m=[];function j(e,t,n){return e.x=t,e.y=n,e==s&&r.panTo(t,n,100),r.move(e.id,t,n,100)}function ae(e){let t=p(e.x,e.y);return j(e,...t.random())}async function re(e,t){let n=z(e,t);if(B(n),t==s)return r.fx(t.id,"pulse");{await O(t);let o=m.indexOf(t);m.splice(o),e.goal={type:"idle"}}}function ie(e){let t=W(e.x,e.y);if(!t)return;let n=D(e,t);B(n),$(t),t.weapon&&(e.weapon=t.weapon),e.goal={type:"idle"}}function G(e,t,n){return f(e.x,e.y,t.x,t.y)<=n}function U(e,t){let n=p(e.x,e.y),o=[],a=1/0;return n.forEach(i=>{let u=M(...i,t.x,t.y);u<a&&(a=u,o=[]),u==a&&o.push(i)}),j(e,...o.random())}function se(e){switch(e.goal.type){case"idle":return ae(e);case"attack":return G(e,e.goal.target,1)?re(e,e.goal.target):U(e,e.goal.target);case"pickup":return G(e,e.goal.target,0)?ie(e):U(e,e.goal.target)}}async function K(){k();let e=m.shift();if(await se(e),m.push(e),e==s&&e.goal.type=="idle"){let t=A();if(t.length>0)e.goal={type:"pickup",target:t[0]};else{let n=F();m.push(n)}}}function N(){b(s,...S("hero")),m.push(s)}function me(){q(),T(),N()}async function ue(){for(;;)await K(),await E(300)}me();ue();
